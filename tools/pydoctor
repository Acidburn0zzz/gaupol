#!/bin/bash

# Generate and view API documentation with pydoctor.
# Usage: pydoctor [browse]
#
# Requires highlight and pydoctor.
# http://www.andre-simon.de/
# http://codespeak.net/~mwh/pydoctor/

cd $(dirname "$0")/..
DOCDIR=doc/api
DATADIR=$(dirname "$0")/data
PATHS=$(find gaupol -type f -name "*.py" | grep -v "/test/")
rm -rf $DOCDIR

for path in $PATHS; do
    echo $DOCDIR/$path.html
    dest=$DOCDIR/$path.html
    mkdir --parents $(dirname $dest)
    highlight \
        --output=$dest \
        --xhtml \
        --style-outfile=code.css \
        --line-number-width=4 \
        --linenumbers \
        --encoding=ascii \
        --anchors \
        $path
    sed -i "s|^\(<a id=.\)l_|\1L|" $dest
    cp -f $DATADIR/code.css $(dirname $dest)
done

pydoctor \
    --make-html \
    --add-package=gaupol \
    --docformat=plaintext \
    --html-output=$DOCDIR \
    --html-viewsource-base=gaupol \
    --project-name=Gaupol \
    --project-url=http://home.gna.org/gaupol/ \
    --resolve-aliases
cp $DATADIR/apidocs.css $DOCDIR

if [[ $1 == "browse" ]]; then
    $BROWSER $DOCDIR/index.html &
fi
