#!/bin/bash

# Generate API documentation with pydoctor.
# Usage: pydoctor [browse]
# Requires highlight and pydoctor.
# http://www.andre-simon.de/
# http://codespeak.net/~mwh/pydoctor/

cd $(dirname "$0")/..
DOC_DIR=doc/api
DATA_DIR=$(dirname "$0")/data
PATHS=$(find gaupol -type f -name "*.py" | grep -v "/test/")
rm -rf $DOC_DIR

for path in $PATHS; do
    echo $DOC_DIR/$path.html
    dest=$DOC_DIR/$path.html
    mkdir --parents $(dirname $dest)
    highlight \
        --output=$dest \
        --xhtml \
        --style-outfile=code.css \
        --line-number-width=4 \
        --linenumbers \
        --encoding=ascii \
        --anchors \
        $path
    sed -i "s|^\(<a id=.\)l_|\1L|" $dest
    cp $DATA_DIR/code.css $(dirname $dest)
done

pydoctor \
    --make-html \
    --add-package=gaupol \
    --docformat=plaintext \
    --html-output=$DOC_DIR \
    --html-viewsource-base=gaupol \
    --project-name=Gaupol \
    --project-url=http://home.gna.org/gaupol/ \
    --resolve-aliases
cp $DATA_DIR/apidocs.css $DOC_DIR
